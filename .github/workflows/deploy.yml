name: Deploy to PythonAnywhere

# Trigger on push to main branch OR manual trigger
on:
  push:
    branches:
      - main
  workflow_dispatch:   # consente il deploy manuale da GitHub Actions

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: deploy via SSH to PythonAnywhere
      - name: Deploy to PythonAnywhere
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ssh.pythonanywhere.com
          username: sasadangelo
          key: ${{ secrets.PYTHONANYWHERE_SSH_KEY }}
          port: 22
          debug: true
          script: |
            cd ~/races
            git reset --hard
            git pull origin main
            echo "üí° DEBUG: list virtualenv"
            ls -la ~/venv/races/bin
            echo "üí° DEBUG: python version"
            ~/venv/races/bin/python --version || echo "‚ùå python not found"
            echo "üí° DEBUG: pip version"
            ~/venv/races/bin/pip --version || echo "‚ùå pip not found"
            echo "üí° DEBUG: install requirements"
            ~/venv/races/bin/pip install -r requirements.txt --disable-pip-version-check || echo "‚ùå pip install failed"
            touch /var/www/sasadangelo_pythonanywhere_com_wsgi.py
            echo "‚úÖ Deployment completed!"