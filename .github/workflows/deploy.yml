name: Deploy to PythonAnywhere

# Trigger on push to main branch OR manual trigger
on:
  push:
    branches:
      - main
  workflow_dispatch: # consente il deploy manuale da GitHub Actions

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: deploy via SSH to PythonAnywhere
      - name: Deploy to PythonAnywhere
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ssh.pythonanywhere.com
          username: sasadangelo
          key: ${{ secrets.PYTHONANYWHERE_SSH_KEY }}
          port: 22
          debug: true
          script: |
            set -x
            # Navigate to project folder
            cd ~/races

            # Reset any local changes and pull latest code
            git reset --hard
            git pull origin main

            # Install/update dependencies
            # Force login shell so uv trova la .python-version e la virtualenv corretta
            uv sync --verbose

            # Touch WSGI file to trigger reload
            touch /var/www/sasadangelo_pythonanywhere_com_wsgi.py

            echo "âœ… Deployment completed!"
